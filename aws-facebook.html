<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8">
  <script src="aws-sdk-2.117.0.js"></script>
  <meta name="google-signin-scope" content="profile email">
  <meta name="google-signin-client_id" content="885265693601-q38bh4n7s7rdrv6lpn4qbb6sbt065pum.apps.googleusercontent.com">
  <script>
    // global
    AWS.config.region = 'us-east-1';
    AWS.config.credentials = new AWS.CognitoIdentityCredentials({
      IdentityPoolId: 'us-east-1:455a20ab-254e-4738-8e6c-cfdcaf54dc79',
    });
    var dynamodb = new AWS.DynamoDB();
    var docClient = new AWS.DynamoDB.DocumentClient();


    function errorFcn(err) {
      console.log(JSON.stringify(err, undefined, 2));
    }


    // facebook login 
    window.fbAsyncInit = function () {
      FB.init({
        appId: '280921122406136',
        cookie: true,
        xfbml: true,
        version: 'v2.10'
      });
      FB.AppEvents.logPageView();
    };

    (function (d, s, id) {
      var js, fjs = d.getElementsByTagName(s)[0];
      if (d.getElementById(id)) {
        return;
      }
      js = d.createElement(s);
      js.id = id;
      js.src = "//connect.facebook.net/en_US/sdk.js";
      fjs.parentNode.insertBefore(js, fjs);
    }(document, 'script', 'facebook-jssdk'));

    function fblogin() {
      FB.login(function (response) {
        // Check if the user logged in successfully.
        if (response.authResponse) {
          console.log('You are now logged in.');
          console.log(response.authResponse.userID); // unique id
          // Add the Facebook access token to the Cognito credentials login map.
          AWS.config.credentials.params.Logins = {};
          AWS.config.credentials.params.Logins['graph.facebook.com'] = response.authResponse.accessToken;
          // Obtain AWS credentials
          AWS.config.credentials.get(errorFcn);
          afterLogIn();
        } else {
          console.log('There was a problem logging you in.');
        }
      });
    }

    function fblogout() {
      FB.getLoginStatus(function (response) {
        if (response.status === 'connected') {
          var uid = response.authResponse.userID;
          var accessToken = response.authResponse.accessToken;
          FB.api('/' + uid + '/permissions', 'delete', function (response) {
            if (response.success) {
              console.log("Facebook account is logged out of app");
            } else {
              console.log("Facebook account is not logged out of app");
            }
          });
        } else if (response.status === 'not_authorized') {} else {}
      });
    }

    // google login
    function loadApi() {
      gapi.load('auth2', function () {
        auth2 = gapi.auth2.init({
          client_id: '885265693601-q38bh4n7s7rdrv6lpn4qbb6sbt065pum.apps.googleusercontent.com',
        });
        // attachSignin(document.getElementById('googlelogin'));
      });
    }

    function attachSignin(element) {
      console.log(element.id);
      auth2.attachClickHandler(element, {}, googlelogin,
        function (error) {
          alert(JSON.stringify(error, undefined, 2));
        });
    }

    function googlelogin() {
      let authInst = gapi.auth2.getAuthInstance();
      authInst.signIn({
        scope: "profile email"
      }).then(googleUser => {
        console.log(googleUser.getBasicProfile().getName());
        console.log(googleUser.getAuthResponse());
        console.log(googleUser.getId()); // unique id
        let authResult = googleUser.getAuthResponse();
        AWS.config.credentials.params.Logins = {};
        AWS.config.credentials.params.Logins['accounts.google.com'] = authResult['id_token'];
        // Obtain AWS credentials
        AWS.config.credentials.get(errorFcn);
        afterLogIn();
      }, error => {
        console.log(error)
      });
    }

    function googlelogout() {
      let authInst = gapi.auth2.getAuthInstance();
      if (authInst.isSignedIn.get()) {
        console.log(authInst.signOut().then(resp => {
          console.log("Google account is logged out");
        }, error => {
          console.log("Google account is not logged out. Error:", error);
        }));
      }
    }

    // dynamoDB
    function afterLogIn() {
      // createMovies();
      // createItem();
      readItem();
    }

    function createMovies() {
      var params = {
        TableName: "Movies",
        KeySchema: [{
            AttributeName: "year",
            KeyType: "HASH"
          },
          {
            AttributeName: "title",
            KeyType: "RANGE"
          }
        ],
        AttributeDefinitions: [{
            AttributeName: "year",
            AttributeType: "N"
          },
          {
            AttributeName: "title",
            AttributeType: "S"
          }
        ],
        ProvisionedThroughput: {
          ReadCapacityUnits: 5,
          WriteCapacityUnits: 5
        }
      };

      dynamodb.createTable(params, function (err, data) {
        if (err) {
          document.getElementById('textarea').innerHTML = "Unable to create table: " + "\n" + JSON.stringify(err,
            undefined, 2);
        } else {
          document.getElementById('textarea').innerHTML = "Created table: " + "\n" + JSON.stringify(data, undefined,
            2);
        }
      });
    }

    function createItem() {
      var params = {
        TableName: "Movies",
        Item: {
          "year": 2015,
          "title": "The Big New Movie",
          "info": {
            "plot": "Nothing happens at all.",
            "rating": 0
          }
        }
      };

      docClient.put(params, function (err, data) {
        if (err) {
          document.getElementById('textarea').innerHTML = "Unable to add item: " + "\n" + JSON.stringify(err,
            undefined, 2);
        } else {
          document.getElementById('textarea').innerHTML = "PutItem succeeded: " + "\n" + JSON.stringify(data,
            undefined, 2);
        }
      });
    }

    function readItem() {
      var table = "Movies";
      var year = 2015;
      var title = "The Big New Movie";

      var params = {
        TableName: table,
        Key: {
          "year": year,
          "title": title
        }
      };
      docClient.get(params, function (err, data) {
        if (err) {
          document.getElementById('textarea').innerHTML = "Unable to read item: " + "\n" + JSON.stringify(err,
            undefined, 2);
        } else {
          document.getElementById('textarea').innerHTML = "GetItem succeeded: " + "\n" + JSON.stringify(data,
            undefined, 2);
        }
      });
    }

    function initApp() {
      FB.getLoginStatus(function (response) {
        console.log("facebook log in status:", response.status, response);
        if (response.status === 'connected') {} else if (response.status === 'not_authorized') {} else {}
      });
      authInst = gapi.auth2.getAuthInstance();
      console.log("google log in status:", authInst.isSignedIn.get(), authInst.currentUser.get());
    }
  </script>

</head>

<body>


  <button id="googlelogin" onclick="googlelogin()">Google login</button>
  <button id="googlelogout" onclick="googlelogout()">Google logout</button>

  <button id="fblogin" onclick="fblogin()">facebook login</button>
  <button id="fblogout" onclick="fblogout()">facebook logout</button>

  <div id="textarea">
  </div>

  <script async defer src="https://apis.google.com/js/api.js" onload="this.onload=function(){};loadApi()" onreadystatechange="if (this.readyState === 'complete') this.onload()"></script>
  <script>
    window.onload = initApp;
  </script>
</body>

</html>